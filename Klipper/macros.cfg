###########################
#     Pen Plotter Macros  #
###########################
# Z axis = pen lift
# For: Ender 3

###########################
#     Basic Pen Control   #
###########################

[gcode_macro PEN_UP]
description: Lift the pen using Z axis
variable_height: 10.0           # pen-up height (mm) — adjust to clear paper/clips
gcode:
  G90
  G1 Z{height} F600

[gcode_macro PEN_DOWN]
description: Lower the pen to draw
variable_height: 0.2            # pen-down height (mm) — tune to just touch the surface
gcode:
  G90
  G1 Z{height} F300

###########################
#     Start of Print      #
###########################

[gcode_macro START_PRINT]
description: Home, raise pen, go to center, wait, then start
# Tunables (change here or override via START_PRINT CENTER_WAIT_S=5 etc.)
variable_travel_z: 5.0          # safe Z after the wait
variable_center_wait_s: 10      # seconds to wait at center for attaching pen
gcode:
  G90
  M83                           # relative extruder (harmless if no extruder)
  G28
  PEN_UP

  # Compute bed center from configured limits
  {% set xmin = printer.toolhead.axis_minimum.x|float %}
  {% set ymin = printer.toolhead.axis_minimum.y|float %}
  {% set xmax = printer.toolhead.axis_maximum.x|float %}
  {% set ymax = printer.toolhead.axis_maximum.y|float %}
  {% set cx = (xmax + xmin)/2 %}
  {% set cy = (ymax + ymin)/2 %}

  G1 X{cx} Y{cy} F9000
  
  G4 P{center_wait_s * 1000}    # wait in milliseconds

  G1 Z{travel_z} F600

###########################
#      End of Print       #
###########################

[gcode_macro END_PRINT]
description: Lift pen, move head to X-center, slide bed forward to present drawing
variable_park_z: 10
variable_x_center_offset: 0.0
gcode:
  PEN_UP
  G90
  G1 Z{park_z} F600             # lift pen gently (10 mm at 10 mm/s)

  # Limits
  {% set xmin = printer.toolhead.axis_minimum.x|float %}
  {% set xmax = printer.toolhead.axis_maximum.x|float %}
  {% set ymin = printer.toolhead.axis_minimum.y|float %}
  {% set ymax = printer.toolhead.axis_maximum.y|float %}
  {% set cx = (xmax + xmin)/2 + x_center_offset %}

  # Detect Y-home direction
  {% set homes_to_max = printer.configfile.settings.stepper_y.homing_positive_dir|default(false) %}
  {% set front_y = ymin if homes_to_max else ymax %}

  # 1) Move head to X-center at current Y
  G1 X{cx} F3000                 ; slower move (~50 mm/s)

  # 2) Slide bed all the way to the front
  G1 Y{front_y} F3000            ; slower move (~50 mm/s)

  # 3) Optional: release steppers
  M84

